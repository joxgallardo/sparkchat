# Lightspark Setup Guide

## Overview
This guide will help you set up Lightspark integration for real Bitcoin Lightning Network operations using JWT authentication.

## Prerequisites
1. A Lightspark account at https://app.lightspark.com
2. Access to Lightspark testnet or mainnet
3. Your account ID (already obtained: `0197673c-b416-9af2-0000-e06272dd8c52`)

## Step 1: Get Lightspark Account ID

### 1.1 Account ID
You already have your Account ID: `0197673c-b416-9af2-0000-e06272dd8c52`

## Step 2: Generate Private Key for JWT Signing

### 2.1 Generate RSA Key Pair
Run the provided script to generate your private key:

```bash
node scripts/generate-lightspark-keys.js
```

This will:
- Generate a 2048-bit RSA key pair
- Save keys to `/keys/` directory
- Display the private key for copying to `.env.local`

### 2.2 Alternative: Manual Generation
If you prefer to generate keys manually:

```bash
# Using OpenSSL
openssl genrsa -out lightspark_private.pem 2048
openssl rsa -in lightspark_private.pem -pubout -out lightspark_public.pem

# View private key
cat lightspark_private.pem
```

## Step 3: Configure Environment Variables

### 3.1 Update .env.local
```bash
# Lightspark Configuration (JWT Authentication)
LIGHTSPARK_ACCOUNT_ID=0197673c-b416-9af2-0000-e06272dd8c52
LIGHTSPARK_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
-----END PRIVATE KEY-----"
LIGHTSPARK_TESTNET=true
LIGHTSPARK_NODE_ID=your_node_id_optional

# Environment
USE_MOCK_CLIENT=false
```

### 3.2 Testnet vs Mainnet
- **For development/testing**: Use testnet (`LIGHTSPARK_TESTNET=true`)
- **For production**: Use mainnet (`LIGHTSPARK_TESTNET=false`)

## Step 4: Test the Integration

### 4.1 Test JWT Generation
```bash
# Test JWT generation
node -e "
const { generateLightsparkJWT } = require('./src/services/lightspark-jwt');
console.log('JWT:', generateLightsparkJWT());
"
```

### 4.2 Test Complete Integration
```bash
npx tsx src/services/test-lightspark-integration.ts
```

## Step 5: Wallet Setup

### 5.1 Deploy Wallet (if needed)
If you don't have a wallet deployed:
1. The SDK will automatically deploy a wallet on first use
2. Wait for deployment to complete (status: DEPLOYED)
3. Note the wallet ID for future reference

### 5.2 Fund Your Wallet
1. Use the lightning invoice generated by the deposit function
2. Pay the invoice using any Lightning Network wallet
3. Wait for confirmation

## Troubleshooting

### Common Issues

#### 1. Private Key Errors
```
Error: LIGHTSPARK_PRIVATE_KEY not configured
```
**Solution**: 
- Run `node scripts/generate-lightspark-keys.js`
- Copy the private key to `.env.local`
- Ensure proper PEM format

#### 2. JWT Generation Errors
```
Error: Failed to generate JWT
```
**Solution**: 
- Verify `LIGHTSPARK_ACCOUNT_ID` is set
- Check private key format
- Ensure `jsonwebtoken` package is installed

#### 3. Authentication Errors
```
Error: Failed to authenticate with Lightspark
```
**Solution**: 
- Check JWT claims are correct
- Verify account ID matches
- Ensure testnet/mainnet flag is correct

### Debug Mode
Enable debug logging by setting:
```bash
NODE_ENV=development
```

## Security Notes

1. **Never commit private keys to version control**
2. **Use environment variables for all sensitive data**
3. **Rotate keys regularly**
4. **Use testnet for development**
5. **Keep `/keys/` directory in `.gitignore**

## API Limits

- Lightspark has rate limits on API calls
- Monitor your usage in the dashboard
- Implement proper error handling for rate limit errors

## Support

- Lightspark Documentation: https://docs.lightspark.com
- Lightspark Support: support@lightspark.com
- SDK Documentation: https://github.com/lightsparkdev/lightspark-js

## Quick Start Commands

```bash
# 1. Generate keys
node scripts/generate-lightspark-keys.js

# 2. Configure .env.local with the displayed private key

# 3. Test integration
npx tsx src/services/test-lightspark-integration.ts

# 4. Start development
USE_MOCK_CLIENT=false npm run dev
``` 